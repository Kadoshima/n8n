# n8n SSL Setup Guide

## なぜSSLを別のコンテナで処理すべきか

### 1. セキュリティの観点
- **攻撃対象の分離**: SSLターミネーションを別コンテナで行うことで、アプリケーションコンテナへの直接的な攻撃を防げます
- **証明書の隔離**: SSL証明書をアプリケーションコンテナから分離することで、アプリケーションの脆弱性による証明書漏洩リスクを低減
- **権限の分離**: SSL処理に必要な権限とアプリケーション実行に必要な権限を分離できます

### 2. パフォーマンスの観点
- **リソースの最適化**: SSL/TLS処理は計算コストが高いため、専用コンテナで処理することで負荷分散が可能
- **スケーラビリティ**: リバースプロキシを水平スケールすることで、SSL処理能力を独立して拡張可能
- **キャッシング**: Nginxなどのリバースプロキシは静的コンテンツのキャッシング機能を提供

### 3. 運用・管理の観点
- **証明書管理の一元化**: 複数のサービスがある場合、すべての証明書を一箇所で管理できる
- **更新の簡易化**: Let's Encryptなどの自動更新をリバースプロキシ側で一元管理
- **設定の柔軟性**: リダイレクト、ヘッダー追加、レート制限などの設定を一元管理

### 4. アーキテクチャの観点
- **関心の分離**: アプリケーションはビジネスロジックに集中し、SSL処理はインフラ層で対応
- **標準化**: 多くのプロダクション環境で採用されているベストプラクティス
- **デバッグの容易さ**: 問題の切り分けが簡単（SSL問題なのか、アプリケーション問題なのか）

## Docker Composeを使用したSSL設定

### 構成図
```
Internet → Nginx (SSL終端) → n8n (HTTP)
         ↓
      ポート443           ポート5678
```

### 必要なファイル

1. **docker-compose.ssl.yml** - SSL対応のDocker Compose設定
2. **nginx.conf** - Nginxのリバースプロキシ設定
3. **setup-ssl.sh** - SSL証明書のセットアップスクリプト

### セットアップ手順

1. **SSL証明書の準備**
   - Let's Encryptを使用する場合（推奨）
   - 自己署名証明書を使用する場合（開発環境）

2. **Nginxの設定**
   - HTTPSリスナーの設定
   - n8nへのプロキシ設定
   - セキュリティヘッダーの追加

3. **Docker Composeの起動**
   ```bash
   docker-compose -f docker-compose.ssl.yml up -d
   ```

### セキュリティのベストプラクティス

1. **強力な暗号化設定**
   - TLS 1.2以上を使用
   - 弱い暗号スイートを無効化

2. **セキュリティヘッダー**
   - Strict-Transport-Security
   - X-Frame-Options
   - X-Content-Type-Options

3. **定期的な証明書更新**
   - Let's Encryptの自動更新設定
   - 証明書期限の監視

## トラブルシューティング

### よくある問題

1. **証明書エラー**
   - 証明書のパスを確認
   - 証明書の権限を確認（読み取り可能か）

2. **接続拒否**
   - ファイアウォール設定を確認
   - Dockerネットワークの設定を確認

3. **リダイレクトループ**
   - n8nのWEBHOOK_URLが正しく設定されているか確認
   - Nginxのproxy_set_headerが適切か確認